#kafka

> Apache Kafka - это распределенная и легко масштабируемая система обмена сообщениями с высокой пропускной способностью, которая может в реальном времени обрабатывать любой объем данных.

### Ссылки с материалами
[Основы Kafka](https://www.youtube.com/watch?v=-AZOi3kP9Js)
[Вводный мини курс по Kafka](https://www.youtube.com/watch?v=DvXPKUUl38w&list=PLWCdmr_xDegcuLlhmXdVFyeNzNbVQdwDM&index=2)
[Небольшая статья по Kafka](https://habr.com/ru/companies/slurm/articles/535374/)

### Из чего состоит Kafka
Минимальный верхне-уровневый набор:
- Broker
- Zookeeper
- Consumer
- Producer

#### Broker
>  Broker - это экземпляр kafka сервера.
>  Другими словами - серверное ПО, в которое можно записать/получить данные. При этом он эти данные аккумулирует и правильно сохраняет.

Pадачи, решаемые Kafka broker:
- Прием сообщений
- Хранение сообщений
- Выдача сообщений

#### Kafka clucter
> это совокупность нескольких Kafka брокеров.

Задачи, решаемые Kafka кластером:
- Масштабирование
- Репликация

#### Zookeeper
> Zookeeper - это распределенное хранилище ключей и их значений. В нем хранится различная конфигурация, которую можно менять налету (информация о брокере, топиках, портициях, доступах и т.д.).

Zookeeper хранит данные Kafka кластера, а именно:
- Состояние кластера
- Конфигурация
- Адресная книга

#### Kafka message
> в основном это key-value пары.

Состав полей Kafka сообщения:
- **Key** (опционально) - ключ используется для распределения по кластеру.
- **Value** - содержимое сообщения (массив байт).
- **Timestamp** - время сообщения. (если его не указывать - оно проставится по дефолту)
- **Headers** - набор key-value пар с пользовательскими атрибутами сообщения.

#### Topic
> это стрим данных
> Топик существует в рамках всего кластера. Т.е. каждый топик существует в каждом брокере кластера. А вот партиция существует в рамках топика и => может располагаться только на одном брокере.

Если партиция 1 :
В топике выстраивается очередь сообщений по FIFO. Т.е. в каком порядке сообщения пришли от продюсера, в таком же порядке потребитель их и вычитывает.

Если партиций > 1 :
Сообщения вычитываются из топика не в том порядке, в котором из передал Producer. Но в рамках каждой отдельной партиции вычитывание упорядочено. (<font style="color:red">?</font>)

- Если нужно вычитывать сообщения, от конкретного Producer, строго в порядке их поступления, то необходимо записывать все эти сообщения в одну партицию.
  А т.к. в рамках партиции вычитывание упорядочено, то Consumer вычитает их по FIFO.
- При вычитывании сообщений из топика - они не удаляются.

#### Partitions
> Partitions (от слова part) - т.е. часть топика.

- Партиция существует в рамках топика.
- Партиции имеют порядковый номер в рамках топика, начиная с нуля.
- Партиция делится на сегменты

#### Replications
> Параметр replication-factor (> 1) устанавливает создаваемое количество копий каждой партиции. 

Реплики одной партиции не могу находится на одном брокере.
Одна партиция из всех реплик `(в эту совокурность реплик входит и изначальная партиция, на основе которой создавались остальные реплики)` - назначается лидером.
Остальные реплики - ведомые партиции.
Ведомые партиции могут отставать по обновлению данных от лидера.

Чтение и запись сообщений осуществляется ТОЛЬКО в лидер партицию (лидер реплику).

#### Consumer / Producer
> Consumer и Producer - это наше приложение(-ия), которое на борту имеет модуль Kafka и с его помощью подключается к брокеру Kafka.
> Consumer и Producer могут быть как разные приложения, так и одно.
> Они не могут удалять сообщения из Kafka.

##### Consumer
Consumer читает сообщения сразу из всех лидер партиций. Но это может быть долго и не эффективно. По этому можно объединить потребителей в Consumer Group и каждому потребителю из группы можно назначить определенную партицию, из которой он будет читать сообщения.

##### Kafka Consumer Offset
В Kafka есть системный топик <font style="color:red">_consumer_offsets</font>. В этот топик комитится номер оффсета сообщения партиции, которое последним было обработан Consumer или Consumer Group. 

#### Структура хранения сообщений в файловой системе Kafka
1.  В папке ./logs хранятся папки партиций
   ![[Pasted image 20240112213957.png | 400]]
   Имя папки партиции формируется : <font style="color:red">topicName</font>-<font style="color:green">partitionNumber</font> (<font style="color:red">А</font>-<font style="color:green">0</font>)
2. Внутри папки партиции хранятся уже файлы с данными
   ![[Pasted image 20240112214909.png | 400]]
   - file<font style="color:green">.log</font> - хранятся сообщения
     - Offset - номер сообщения в партиции
     - Position - смещение в этом файле (в видосе говорят байтах (или битах<font style="color:red">?</font>)) до конкретного сообщения
   - file<font style="color:green">.index</font> - маппинг Offset на Position
     ![[Pasted image 20240112215340.png | 200]]
   - file<font style="color:green">.index</font> - маппинг Timestamp на Offset
3. Партиция делится на сегменты (Segments). У file<font style="color:green">.log</font> в партиции есть лимит по размеру (по умолчанию это 1 ГБ). Как только лог файл достигает максимального размера - создается новый сегмент (новая копия всех файлов партиции).
   ![[Pasted image 20240112220042.png | 400]]

### Удаление сообщений из Kafka
> Вручную сообщения удалить нельзя.
> В Kafka поддерживается только автоматическое удаление

Минимальная удаляемая единица - сегмент.

### Когда пригодится kafka
- В качестве инструмента (который разворачивается отдельным приложением) для обмена сообщениями. Особенно если нужно чтобы одинаковые сообщения читали разные приложения.
- Потоковая передача данных.
- Ведение журнала. Kafka все сохраняет в строго организованной структуре.

### Брокер сообщений
> - это архитектурный паттерн в распределённых системах, где элементы системы общаются через посредника. Брокер упрощает работу веб-сервисов, отвечая за пересылку сообщений и все связанные задачи.

В работе брокера сообщений участвуют два ключевых элемента: producer (создатель сообщений) и consumer (получатель/подписчик). Один элемент создает сообщения и отправляет их другому элементу-получателю. В процессе отправки брокер обеспечивает промежуточный этап, сохраняя сообщения от продюсера в определенной папке файловой системы.

#### Когда используются брокеры сообщений
- Отложенное выполнение действий
- Асинхронный обмен сообщениями м/ду сервисами и обеспечение буферизации
- Нужно ускорить обработку сформированных сообщений путем добавления дополнительных подписчиков
- Сгладить пиковые нагрузки, т.к. выполнение задачи и добавление ее в очередь сообщений - имеют разный вес. А далее в брокере сообщений все выполнится в асинхроне.

### Конфигурация Kafka
- bootstrap.servers - это адрес, на котором поднимается kafka.
  По дефолту это `localhost:9092`